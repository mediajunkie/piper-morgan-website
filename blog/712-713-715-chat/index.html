<!DOCTYPE html><!--jkcyPKoNEXxjvxR0A99v8--><html lang="en" class="font-inter"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/f9342e94655f11e9.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-6b3c4bafba00fe32.js"/><script src="/_next/static/chunks/52774a7f-5d3ddaa10fc3b536.js" async=""></script><script src="/_next/static/chunks/4bd1b696-cf72ae8a39fa05aa.js" async=""></script><script src="/_next/static/chunks/833-b5a269c8aaea6261.js" async=""></script><script src="/_next/static/chunks/main-app-05b535a6fc91a304.js" async=""></script><script src="/_next/static/chunks/874-668c89038fa04eb8.js" async=""></script><script src="/_next/static/chunks/212-369ef96a260e510f.js" async=""></script><script src="/_next/static/chunks/app/layout-9ed54623e803ece8.js" async=""></script><script src="/_next/static/chunks/144-1b443e029a921717.js" async=""></script><script src="/_next/static/chunks/674-53253b5555d30dcf.js" async=""></script><script src="/_next/static/chunks/app/blog/page-666765c672eae567.js" async=""></script><script src="/_next/static/chunks/app/blog/%5Bslug%5D/page-63f1c4c60df8aece.js" async=""></script><link rel="preload" href="https://www.googletagmanager.com/gtag/js?id=G-SVPLRHEEBP" as="script"/><link rel="dns-prefetch" href="//pipermorgan.ai"/><link rel="preconnect" href="https://pipermorgan.ai"/><link rel="preload" as="image" href="/assets/pm-logo.png"/><link rel="preload" href="/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/HossRound-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><title>7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14 | Piper Morgan</title><meta name="description" content="July 14"/><meta name="author" content="Christian Crumlish"/><meta name="keywords" content="AI,Product Management,Methodology,Building in Public"/><meta name="creator" content="Christian Crumlish"/><meta name="publisher" content="Christian Crumlish"/><meta name="robots" content="index, follow"/><meta name="googlebot" content="index, follow"/><link rel="canonical" href="https://pipermorgan.ai/"/><meta name="format-detection" content="telephone=no, address=no, email=no"/><meta property="og:title" content="7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14"/><meta property="og:description" content="July 14"/><meta property="og:type" content="article"/><meta property="article:author" content="christian crumlish"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14"/><meta name="twitter:description" content="July 14"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="32x33"/><link rel="icon" href="/favicon.ico" sizes="32x32" type="image/x-icon"/><link rel="icon" href="/pm-favicon-16.png" sizes="16x16" type="image/png"/><link rel="icon" href="/pm-favicon-32.png" sizes="32x32" type="image/png"/><link rel="icon" href="/pm-favicon-48.png" sizes="48x48" type="image/png"/><link rel="apple-touch-icon" href="/pm-favicon-180.png" sizes="180x180" type="image/png"/><link rel="icon" href="/pm-favicon-192.png" sizes="192x192" type="image/png"/><script>
              (function() {
                const theme = localStorage.getItem('theme') ||
                  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                if (theme === 'dark') {
                  document.documentElement.classList.add('dark');
                  document.body.classList.add('dark');
                }
              })();
            </script><style>
            :root{--primary-teal:#2DD4BF;--primary-teal-text:#0D9488;--text-dark:#1F2937;--text-light:#6B7280;--background:#FFFFFF;--surface:#F9FAFB}
            .dark{--text-dark:#F1F5F9;--text-light:#94A3B8;--background:#0F172A;--surface:#1E293B}
            @font-face{font-family:'Inter';src:url('/fonts/inter-latin.woff2') format('woff2');font-weight:100 900;font-style:normal;font-display:swap;unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}
            *{box-sizing:border-box}
            html{scroll-behavior:smooth;font-size:16px;margin:0;padding:0;border:none;outline:none}
            body{background:var(--background);color:var(--text-dark);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;line-height:1.6;margin:0;padding:0;border:none;outline:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
            nav{border:none !important;outline:none !important}
            h1,h2,h3,h4,h5,h6{font-family:'Hoss Round','Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
            p,span{max-width:75ch;line-height:1.7}
            .text-content div{max-width:75ch;line-height:1.7}
            .text-content{max-width:65ch}
            @media (max-width:640px){
              h1{font-size:1.75rem;line-height:1.2}
              h2{font-size:1.25rem;line-height:1.3}
              h3{font-size:1.1rem;line-height:1.4}
              h4{font-size:1rem;line-height:1.4}
            }
            @media (min-width:641px) and (max-width:768px){
              h1{font-size:2rem;line-height:1.2}
              h2{font-size:1.5rem;line-height:1.3}
              h3{font-size:1.25rem;line-height:1.4}
            }
            @media (prefers-reduced-motion: reduce){
              *{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important}
            }
            a:hover{color:#0D9488;transition:color 0.2s ease}
            .hover-lift:hover{transform:translateY(-2px);transition:transform 0.2s ease}
            button:focus,a:focus{outline:2px solid #2DD4BF;outline-offset:2px;border-radius:4px}
            .skip-to-content{position:absolute;top:-100px;left:0;z-index:999;padding:8px 16px;background:#1F2937;color:white;text-decoration:none;border-radius:0 0 4px 0;transition:top 0.3s}
            .skip-to-content:focus{top:0;outline:2px solid #2DD4BF;outline-offset:2px}
            .section-spacing{margin-bottom:4rem}
            .component-spacing{margin-bottom:1.5rem}
            .micro-spacing{margin-bottom:0.5rem}
            @media (min-width:768px){
              .section-spacing{margin-bottom:6rem}
              .component-spacing{margin-bottom:2rem}
            }
            .site-container{width:100%;max-width:1200px;margin-left:auto;margin-right:auto;padding-left:1rem;padding-right:1rem}
            @media (min-width:640px){.site-container{padding-left:1.5rem;padding-right:1.5rem}}
            @media (min-width:768px){.site-container{padding-left:2rem;padding-right:2rem}}
            @media (min-width:1024px){.site-container{max-width:1200px}}
            @media (min-width:1200px){.site-container{max-width:1200px}}
            .section-padding{padding-top:4rem;padding-bottom:4rem}
            @media (min-width:768px){.section-padding{padding-top:5rem;padding-bottom:5rem}}
            .mx-auto{margin-left:auto;margin-right:auto}
            .max-w-4xl{max-width:56rem}
            .pt-16{padding-top:4rem}
            .pb-8{padding-bottom:2rem}
            .px-4{padding-left:1rem;padding-right:1rem}
            .mb-6{margin-bottom:1.5rem}
            .mb-8{margin-bottom:2rem}
            .text-left{text-align:left}
            .text-center{text-align:center}
            .text-primary-teal-text{color:#0F766E}
            .text-text-dark{color:#1F2937}
            .text-text-light{color:#6B7280}
            .font-bold{font-weight:700}
            .text-4xl{font-size:2.25rem;line-height:2.5rem}
            .text-5xl{font-size:3rem;line-height:1}
            .text-6xl{font-size:3.75rem;line-height:1}
            .text-lg{font-size:1.125rem;line-height:1.75rem}
            .text-xl{font-size:1.25rem;line-height:1.75rem}
            .leading-tight{line-height:1.25}
            .leading-relaxed{line-height:1.625}
            .min-h-screen{min-height:100vh}
            @media (min-width:768px){
              .md\:pt-24{padding-top:6rem}
              .md\:pb-12{padding-bottom:3rem}
              .md\:text-5xl{font-size:3rem;line-height:1}
              .md\:text-xl{font-size:1.25rem;line-height:1.75rem}
            }
            @media (min-width:1024px){
              .lg\:text-6xl{font-size:3.75rem;line-height:1}
            }
          </style><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="font-sans antialiased"><div hidden=""><!--$--><!--/$--></div><script src="/_next/static/chunks/webpack-6b3c4bafba00fe32.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n8:I[8393,[],\"\"]\n:HL[\"/_next/static/css/f9342e94655f11e9.css\",\"style\"]\n2:T1313,"])</script><script>self.__next_f.push([1,"\n            :root{--primary-teal:#2DD4BF;--primary-teal-text:#0D9488;--text-dark:#1F2937;--text-light:#6B7280;--background:#FFFFFF;--surface:#F9FAFB}\n            .dark{--text-dark:#F1F5F9;--text-light:#94A3B8;--background:#0F172A;--surface:#1E293B}\n            @font-face{font-family:'Inter';src:url('/fonts/inter-latin.woff2') format('woff2');font-weight:100 900;font-style:normal;font-display:swap;unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}\n            *{box-sizing:border-box}\n            html{scroll-behavior:smooth;font-size:16px;margin:0;padding:0;border:none;outline:none}\n            body{background:var(--background);color:var(--text-dark);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;line-height:1.6;margin:0;padding:0;border:none;outline:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}\n            nav{border:none !important;outline:none !important}\n            h1,h2,h3,h4,h5,h6{font-family:'Hoss Round','Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}\n            p,span{max-width:75ch;line-height:1.7}\n            .text-content div{max-width:75ch;line-height:1.7}\n            .text-content{max-width:65ch}\n            @media (max-width:640px){\n              h1{font-size:1.75rem;line-height:1.2}\n              h2{font-size:1.25rem;line-height:1.3}\n              h3{font-size:1.1rem;line-height:1.4}\n              h4{font-size:1rem;line-height:1.4}\n            }\n            @media (min-width:641px) and (max-width:768px){\n              h1{font-size:2rem;line-height:1.2}\n              h2{font-size:1.5rem;line-height:1.3}\n              h3{font-size:1.25rem;line-height:1.4}\n            }\n            @media (prefers-reduced-motion: reduce){\n              *{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important}\n            }\n            a:hover{color:#0D9488;transition:color 0.2s ease}\n            .hover-lift:hover{transform:translateY(-2px);transition:transform 0.2s ease}\n            button:focus,a:focus{outline:2px solid #2DD4BF;outline-offset:2px;border-radius:4px}\n            .skip-to-content{position:absolute;top:-100px;left:0;z-index:999;padding:8px 16px;background:#1F2937;color:white;text-decoration:none;border-radius:0 0 4px 0;transition:top 0.3s}\n            .skip-to-content:focus{top:0;outline:2px solid #2DD4BF;outline-offset:2px}\n            .section-spacing{margin-bottom:4rem}\n            .component-spacing{margin-bottom:1.5rem}\n            .micro-spacing{margin-bottom:0.5rem}\n            @media (min-width:768px){\n              .section-spacing{margin-bottom:6rem}\n              .component-spacing{margin-bottom:2rem}\n            }\n            .site-container{width:100%;max-width:1200px;margin-left:auto;margin-right:auto;padding-left:1rem;padding-right:1rem}\n            @media (min-width:640px){.site-container{padding-left:1.5rem;padding-right:1.5rem}}\n            @media (min-width:768px){.site-container{padding-left:2rem;padding-right:2rem}}\n            @media (min-width:1024px){.site-container{max-width:1200px}}\n            @media (min-width:1200px){.site-container{max-width:1200px}}\n            .section-padding{padding-top:4rem;padding-bottom:4rem}\n            @media (min-width:768px){.section-padding{padding-top:5rem;padding-bottom:5rem}}\n            .mx-auto{margin-left:auto;margin-right:auto}\n            .max-w-4xl{max-width:56rem}\n            .pt-16{padding-top:4rem}\n            .pb-8{padding-bottom:2rem}\n            .px-4{padding-left:1rem;padding-right:1rem}\n            .mb-6{margin-bottom:1.5rem}\n            .mb-8{margin-bottom:2rem}\n            .text-left{text-align:left}\n            .text-center{text-align:center}\n            .text-primary-teal-text{color:#0F766E}\n            .text-text-dark{color:#1F2937}\n            .text-text-light{color:#6B7280}\n            .font-bold{font-weight:700}\n            .text-4xl{font-size:2.25rem;line-height:2.5rem}\n            .text-5xl{font-size:3rem;line-height:1}\n            .text-6xl{font-size:3.75rem;line-height:1}\n            .text-lg{font-size:1.125rem;line-height:1.75rem}\n            .text-xl{font-size:1.25rem;line-height:1.75rem}\n            .leading-tight{line-height:1.25}\n            .leading-relaxed{line-height:1.625}\n            .min-h-screen{min-height:100vh}\n            @media (min-width:768px){\n              .md\\:pt-24{padding-top:6rem}\n              .md\\:pb-12{padding-bottom:3rem}\n              .md\\:text-5xl{font-size:3rem;line-height:1}\n              .md\\:text-xl{font-size:1.25rem;line-height:1.75rem}\n            }\n            @media (min-width:1024px){\n              .lg\\:text-6xl{font-size:3.75rem;line-height:1}\n            }\n          "])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"jkcyPKoNEXxjvxR0A99v8\",\"p\":\"\",\"c\":[\"\",\"blog\",\"712-713-715-chat\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"712-713-715-chat\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f9342e94655f11e9.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"font-inter\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"script\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"\\n              (function() {\\n                const theme = localStorage.getItem('theme') ||\\n                  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');\\n                if (theme === 'dark') {\\n                  document.documentElement.classList.add('dark');\\n                  document.body.classList.add('dark');\\n                }\\n              })();\\n            \"}}],[\"$\",\"link\",null,{\"rel\":\"dns-prefetch\",\"href\":\"//pipermorgan.ai\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://pipermorgan.ai\"}],[\"$\",\"link\",null,{\"rel\":\"preload\",\"as\":\"image\",\"href\":\"/assets/pm-logo.png\"}],[\"$\",\"link\",null,{\"rel\":\"preload\",\"href\":\"/fonts/inter-latin.woff2\",\"as\":\"font\",\"type\":\"font/woff2\",\"crossOrigin\":\"anonymous\"}],[\"$\",\"link\",null,{\"rel\":\"preload\",\"href\":\"/fonts/HossRound-Regular.woff2\",\"as\":\"font\",\"type\":\"font/woff2\",\"crossOrigin\":\"anonymous\"}],[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$2\"}}]]}],\"$L3\"]}]]}],{\"children\":[\"blog\",\"$L4\",{\"children\":[[\"slug\",\"712-713-715-chat\",\"d\"],\"$L5\",{\"children\":[\"__PAGE__\",\"$L6\",{},null,false]},null,false]},null,false]},null,false],\"$L7\",false]],\"m\":\"$undefined\",\"G\":[\"$8\",[]],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"9:I[9119,[\"874\",\"static/chunks/874-668c89038fa04eb8.js\",\"212\",\"static/chunks/212-369ef96a260e510f.js\",\"177\",\"static/chunks/app/layout-9ed54623e803ece8.js\"],\"ClientLayout\"]\na:I[7555,[],\"\"]\nb:I[1295,[],\"\"]\nc:I[6874,[\"874\",\"static/chunks/874-668c89038fa04eb8.js\",\"212\",\"static/chunks/212-369ef96a260e510f.js\",\"144\",\"static/chunks/144-1b443e029a921717.js\",\"674\",\"static/chunks/674-53253b5555d30dcf.js\",\"831\",\"static/chunks/app/blog/page-666765c672eae567.js\"],\"\"]\n10:I[9665,[],\"OutletBoundary\"]\n12:I[4911,[],\"AsyncMetadataOutlet\"]\n14:I[9665,[],\"ViewportBoundary\"]\n16:I[9665,[],\"MetadataBoundary\"]\n17:\"$Sreact.suspense\"\n"])</script><script>self.__next_f.push([1,"3:[\"$\",\"body\",null,{\"className\":\"font-sans antialiased\",\"children\":[[\"$\",\"$L9\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"min-h-screen\",\"children\":[\"$\",\"div\",null,{\"className\":\"site-container max-w-4xl pt-16 md:pt-24 pb-8 md:pb-12 text-center\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-8xl md:text-9xl font-bold text-primary-teal-text mb-4\",\"children\":\"404\"}],[\"$\",\"h2\",null,{\"className\":\"text-3xl md:text-4xl font-semibold text-text-dark mb-4\",\"children\":\"Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"text-xl text-text-light leading-relaxed max-w-2xl mx-auto\",\"children\":\"Looks like this page got lost in the AI training data. Don't worry – even the best algorithms make mistakes sometimes.\"}]]}],[\"$\",\"div\",null,{\"className\":\"mb-12\",\"children\":[[\"$\",\"h3\",null,{\"className\":\"text-xl font-semibold text-text-dark mb-6\",\"children\":\"Where would you like to go instead?\"}],[\"$\",\"div\",null,{\"className\":\"grid md:grid-cols-2 gap-6 max-w-2xl mx-auto\",\"children\":[[\"$\",\"div\",null,{\"className\":\"space-y-4\",\"children\":[[\"$\",\"$Lc\",null,{\"href\":\"/\",\"className\":\"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group\",\"children\":[[\"$\",\"h4\",null,{\"className\":\"font-semibold text-text-dark group-hover:text-primary-teal-text\",\"children\":\"🏠 Homepage\"}],[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light mt-1\",\"children\":\"Start from the beginning of our AI PM journey\"}]]}],[\"$\",\"$Lc\",null,{\"href\":\"/how-it-works\",\"className\":\"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group\",\"children\":[[\"$\",\"h4\",null,{\"className\":\"font-semibold text-text-dark group-hover:text-primary-teal-text\",\"children\":\"⚙️ How It Works\"}],[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light mt-1\",\"children\":\"Discover our AI-powered product management methodology\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"space-y-4\",\"children\":[[\"$\",\"$Lc\",null,{\"href\":\"/what-weve-learned\",\"className\":\"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group\",\"children\":[[\"$\",\"h4\",null,{\"className\":\"font-semibold text-text-dark group-hover:text-primary-teal-text\",\"children\":\"💡 What We've Learned\"}],[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light mt-1\",\"children\":\"Building-in-public insights and breakthroughs\"}]]}],[\"$\",\"$Lc\",null,{\"href\":\"/blog\",\"className\":\"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group\",\"children\":[[\"$\",\"h4\",null,{\"className\":\"font-semibold text-text-dark group-hover:text-primary-teal-text\",\"children\":\"📝 Journey\"}],[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light mt-1\",\"children\":\"Follow our building-in-public blog posts\"}]]}],[\"$\",\"$Lc\",null,{\"href\":\"/get-involved\",\"className\":\"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group\",\"children\":[[\"$\",\"h4\",null,{\"className\":\"font-semibold text-text-dark group-hover:text-primary-teal-text\",\"children\":\"🚀 Get Involved\"}],[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light mt-1\",\"children\":\"Join our community and stay updated\"}]]}]]}]]}]]}],[\"$\",\"div\",null,{\"className\":\"text-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"text-text-light mb-6\",\"children\":\"Still can't find what you're looking for?\"}],[\"$\",\"$Lc\",null,{\"href\":\"/get-involved\",\"className\":\"inline-flex items-center justify-center font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none bg-primary-teal text-white hover:bg-teal-600 focus:ring-primary-teal shadow-component hover:shadow-component-hover hover:-translate-y-0.5 hover:scale-105 font-bold text-lg px-8 py-4 text-lg rounded-button\",\"aria-label\":\"$undefined\",\"children\":[false,\"Get Help \u0026 Stay Updated\"]}]]}],[\"$\",\"div\",null,{\"className\":\"mt-12 p-6 bg-gray-50 rounded-card max-w-lg mx-auto\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-sm text-text-light italic\",\"children\":[\"💬 \",\"$Ld\",\" \\\"Even the most sophisticated neural networks occasionally return null. Let's navigate back to more productive paths together!\\\"\"]}]}]]}]}],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],\"$Le\"]}]\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}]\n5:[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}]\n6:[\"$\",\"$1\",\"c\",{\"children\":[\"$Lf\",null,[\"$\",\"$L10\",null,{\"children\":[\"$L11\",[\"$\",\"$L12\",null,{\"promise\":\"$@13\"}]]}]]}]\n7:[\"$\",\"$1\",\"h\",{\"children\":[null,[[\"$\",\"$L14\",null,{\"children\":\"$L15\"}],null],[\"$\",\"$L16\",null,{\"children\":[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$17\",null,{\"fallback\":null,\"children\":\"$L18\"}]}]}]]}]\n"])</script><script>self.__next_f.push([1,"19:I[9795,[\"874\",\"static/chunks/874-668c89038fa04eb8.js\",\"212\",\"static/chunks/212-369ef96a260e510f.js\",\"177\",\"static/chunks/app/layout-9ed54623e803ece8.js\"],\"default\"]\nd:[\"$\",\"strong\",null,{\"children\":\"Piper Morgan says:\"}]\ne:[\"$\",\"$L19\",null,{}]\n"])</script><script>self.__next_f.push([1,"1a:I[7887,[\"874\",\"static/chunks/874-668c89038fa04eb8.js\",\"953\",\"static/chunks/app/blog/%5Bslug%5D/page-63f1c4c60df8aece.js\"],\"BlogPostContent\"]\n1b:T62fc,"])</script><script>self.__next_f.push([1,"\u003csection name=\"58ba\" class=\"section section--body section--first\"\u003e\u003cdiv class=\"section-divider\"\u003e\u003chr class=\"section-divider\"\u003e\u003c/div\u003e\u003cdiv class=\"section-content\"\u003e\u003cdiv class=\"section-inner sectionLayout--insetColumn\"\u003e\u003ch3 name=\"4c57\" id=\"4c57\" class=\"graf graf--h3 graf--leading graf--title\"\u003eFrom Broken Tests to Perfect Architecture: The Great Cleanup\u003c/h3\u003e\u003cfigure name=\"94f4\" id=\"94f4\" class=\"graf graf--figure graf--startsWithDoubleQuote graf-after--h3\"\u003e\u003cimg class=\"graf-image\" data-image-id=\"1*gt2lNbkYQVHRL5JZCpHaNg.png\" data-width=\"1536\" data-height=\"1024\" data-is-featured=\"true\" alt=\"A person and a robot clean up a house that was hit by a hurricane\" src=\"https://cdn-images-1.medium.com/max/800/1*gt2lNbkYQVHRL5JZCpHaNg.png\"\u003e\u003cfigcaption class=\"imageCaption\"\u003e“We’ll make it better than new”\u003c/figcaption\u003e\u003c/figure\u003e\u003cp name=\"b43a\" id=\"b43a\" class=\"graf graf--p graf-after--figure\"\u003e\u003cem class=\"markup--em markup--p-em\"\u003eJuly 14\u003c/em\u003e\u003c/p\u003e\u003cp name=\"9ca2\" id=\"9ca2\" class=\"graf graf--p graf--hasDropCapModel graf--hasDropCap graf-after--p\"\u003e\u003cspan class=\"graf-dropCap\"\u003eW\u003c/span\u003ehat started as “let’s fix these 9 failing FileRepository tests” became “let’s eliminate three years–worth of accumulated technical debt and achieve 100% architectural pattern compliance.” Sometimes the best debugging sessions are the ones that refuse to stay in their lane.\u003c/p\u003e\u003cp name=\"0537\" id=\"0537\" class=\"graf graf--p graf-after--p\"\u003e(How we accumulated that much tech debt in less than three weeks is another testament to the power of AI.)\u003c/p\u003e\u003cp name=\"737f\" id=\"737f\" class=\"graf graf--p graf-after--p\"\u003eEventually, we discovered that our test failures weren’t just broken tests — they were symptoms of fundamental architectural inconsistencies that had been lurking beneath a mostly-working system. By the end of a 14-hour session, we’d eliminated dual repository implementations, standardized on consistent patterns, and achieved something every architect dreams of: a codebase where everything follows the same rules.\u003c/p\u003e\u003ch3 name=\"752a\" id=\"752a\" class=\"graf graf--h3 graf-after--p\"\u003eThe deceptively simple starting point\u003c/h3\u003e\u003cp name=\"1c40\" id=\"1c40\" class=\"graf graf--p graf-after--h3\"\u003eFresh off PM-011’s completion and the test suite recovery to 87% pass rate, I thought July 14 would be a cleanup day. Just 27 remaining test failures across a few categories:\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"9f78\" id=\"9f78\" class=\"graf graf--li graf-after--p\"\u003e9 FileRepository tests (connection pool vs session mismatch)\u003c/li\u003e\u003cli name=\"f3fd\" id=\"f3fd\" class=\"graf graf--li graf-after--li\"\u003e3 API query tests (session management issues)\u003c/li\u003e\u003cli name=\"265b\" id=\"265b\" class=\"graf graf--li graf-after--li\"\u003e14 assertion drift tests (float precision, logic updates)\u003c/li\u003e\u003cli name=\"43c7\" id=\"43c7\" class=\"graf graf--li graf-after--li\"\u003e1 miscellaneous test (dataclass issue)\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"54d4\" id=\"54d4\" class=\"graf graf--p graf-after--li\"\u003eThe FileRepository failures looked straightforward: tests were providing AsyncSession objects, but the repository expected connection pools with an \u003ccode class=\"markup--code markup--p-code\"\u003e.acquire()\u003c/code\u003e method. Classic interface mismatch. Should be a quick fix, right?\u003c/p\u003e\u003cp name=\"fd00\" id=\"fd00\" class=\"graf graf--p graf-after--p\"\u003eFamous last words.\u003c/p\u003e\u003ch3 name=\"bfdd\" id=\"bfdd\" class=\"graf graf--h3 graf-after--p\"\u003eThe revealing architectural audit\u003c/h3\u003e\u003cp name=\"3697\" id=\"3697\" class=\"graf graf--p graf-after--h3\"\u003eInstead of band-aiding the FileRepository issue, I asked Claude Code to investigate our database patterns more systematically. What came back was a comprehensive architectural compliance audit that revealed uncomfortable truths about our codebase.\u003c/p\u003e\u003cp name=\"1a6e\" id=\"1a6e\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eRepository Compliance: 71% (5/7 repositories)\u003c/strong\u003e\u003c/p\u003e\u003cp name=\"36b0\" id=\"36b0\" class=\"graf graf--p graf-after--p\"\u003eThe audit identified seven repositories across the system:\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"e3e9\" id=\"e3e9\" class=\"graf graf--li graf-after--p\"\u003e✅ 5 repositories fully compliant with our documented Pattern #1\u003c/li\u003e\u003cli name=\"ee46\" id=\"ee46\" class=\"graf graf--li graf-after--li\"\u003e❌ 1 repository using legacy raw SQL + connection pools\u003c/li\u003e\u003cli name=\"6800\" id=\"6800\" class=\"graf graf--li graf-after--li\"\u003e⚠️ 1 repository in the wrong architectural layer\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"4194\" id=\"4194\" class=\"graf graf--p graf-after--li\"\u003eBut the real shock was the footnote: \u003cstrong class=\"markup--strong markup--p-strong\"\u003e“Dual WorkflowRepository implementation detected.”\u003c/strong\u003e\u003c/p\u003e\u003cp name=\"bb12\" id=\"bb12\" class=\"graf graf--p graf-after--p\"\u003eWe had two completely different WorkflowRepository classes in the codebase. Not variations on a theme — completely different implementations using different patterns, serving different parts of the system. (I was getting déjà vu again. Why did we keep “discovering” that we’d built parallel solutions in the past?)\u003c/p\u003e\u003ch3 name=\"b686\" id=\"b686\" class=\"graf graf--h3 graf-after--p\"\u003eThe detective work begins\u003c/h3\u003e\u003cp name=\"f321\" id=\"f321\" class=\"graf graf--p graf-after--h3\"\u003eThe FileRepository investigation led to a broader question: how much legacy code were we carrying from before we established architectural patterns?\u003c/p\u003e\u003cp name=\"6ae0\" id=\"6ae0\" class=\"graf graf--p graf-after--p\"\u003eClaude Code’s analysis revealed the scope:\u003c/p\u003e\u003cp name=\"0583\" id=\"0583\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eLegacy Pattern (Raw SQL + Connection Pools):\u003c/strong\u003e\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"python\" name=\"2dab\" id=\"2dab\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFileRepository\u003c/span\u003e:\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, db_pool\u003c/span\u003e):\u003cbr /\u003e        self.db_pool = db_pool\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eget_file_by_id\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself, file_id: \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e\u003c/span\u003e):\u003cbr /\u003e        \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e self.db_pool.acquire() \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e conn:\u003cbr /\u003e            row = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e conn.fetchrow(\u003cspan class=\"hljs-string\"\u003e\u0026quot;SELECT * FROM uploaded_files WHERE id = $1\u0026quot;\u003c/span\u003e, file_id)\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"5d3a\" id=\"5d3a\" class=\"graf graf--p graf-after--pre\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eModern Pattern (SQLAlchemy + Sessions):\u003c/strong\u003e\u003c/p\u003e\u003cp name=\"5182\" id=\"5182\" class=\"graf graf--p graf-after--p\"\u003epython\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"ruby\" name=\"d2e6\" id=\"d2e6\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFileRepository\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eBaseRepository\u003c/span\u003e):\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-variable language_\"\u003eself\u003c/span\u003e, \u003cspan class=\"hljs-symbol\"\u003esession:\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAsyncSession\u003c/span\u003e\u003c/span\u003e):\u003cbr /\u003e        \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e().__init__(session, \u003cspan class=\"hljs-title class_\"\u003eUploadedFile\u003c/span\u003eDB)\u003cbr /\u003e    async \u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eget_file_by_id\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-variable language_\"\u003eself\u003c/span\u003e, \u003cspan class=\"hljs-symbol\"\u003efile_id:\u003c/span\u003e str\u003c/span\u003e) -\u0026gt; \u003cspan class=\"hljs-title class_\"\u003eOptional\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eUploadedFile\u003c/span\u003e]:\u003cbr /\u003e        result = await \u003cspan class=\"hljs-variable language_\"\u003eself\u003c/span\u003e.session.execute(\u003cbr /\u003e            select(\u003cspan class=\"hljs-title class_\"\u003eUploadedFile\u003c/span\u003eDB).where(\u003cspan class=\"hljs-title class_\"\u003eUploadedFile\u003c/span\u003eDB.id == file_id)\u003cbr /\u003e        )\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"f33f\" id=\"f33f\" class=\"graf graf--p graf-after--pre\"\u003eThe FileRepository was essentially prototype code that had never been migrated to our documented patterns. It worked, but it violated every architectural principle we’d established.\u003c/p\u003e\u003cp name=\"3ffc\" id=\"3ffc\" class=\"graf graf--p graf-after--p\"\u003eSuddenly, I was having nightmares again about the legacy spaghetti that powered AOL Instant Messenger in its final days.\u003c/p\u003e\u003ch3 name=\"49b9\" id=\"49b9\" class=\"graf graf--h3 graf-after--p\"\u003eThe dual WorkflowRepository mystery\u003c/h3\u003e\u003cp name=\"c9db\" id=\"c9db\" class=\"graf graf--p graf-after--h3\"\u003eThe WorkflowRepository situation was more complex. We had two implementations:\u003c/p\u003e\u003cp name=\"e8a1\" id=\"e8a1\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eLegacy version\u003c/strong\u003e (\u003ccode class=\"markup--code markup--p-code\"\u003eservices/repositories/workflow_repository.py\u003c/code\u003e):\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"5495\" id=\"5495\" class=\"graf graf--li graf-after--p\"\u003eRaw SQL with connection pools\u003c/li\u003e\u003cli name=\"1c59\" id=\"1c59\" class=\"graf graf--li graf-after--li\"\u003eUsed by API endpoints for read operations\u003c/li\u003e\u003cli name=\"b4a0\" id=\"b4a0\" class=\"graf graf--li graf-after--li\"\u003eMethods: \u003ccode class=\"markup--code markup--li-code\"\u003efind_by_id()\u003c/code\u003e, \u003ccode class=\"markup--code markup--li-code\"\u003esave()\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"400b\" id=\"400b\" class=\"graf graf--p graf-after--li\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eModern version\u003c/strong\u003e (\u003ccode class=\"markup--code markup--p-code\"\u003eservices/database/repositories.py\u003c/code\u003e):\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"6fa3\" id=\"6fa3\" class=\"graf graf--li graf-after--p\"\u003eInherits from BaseRepository\u003c/li\u003e\u003cli name=\"06ee\" id=\"06ee\" class=\"graf graf--li graf-after--li\"\u003eUsed by orchestration engine for write operations\u003c/li\u003e\u003cli name=\"7598\" id=\"7598\" class=\"graf graf--li graf-after--li\"\u003eMethods: \u003ccode class=\"markup--code markup--li-code\"\u003ecreate_from_domain()\u003c/code\u003e, \u003ccode class=\"markup--code markup--li-code\"\u003eupdate_status()\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"7c64\" id=\"7c64\" class=\"graf graf--p graf-after--li\"\u003eThe interfaces didn’t even overlap! They were serving completely different use cases, with no obvious conflicts. This explained why the duplication had persisted — each implementation worked perfectly for its specific purpose.\u003c/p\u003e\u003cp name=\"f49a\" id=\"f49a\" class=\"graf graf--p graf-after--p\"\u003eBut Claude Code’s investigation revealed the truth: \u003cstrong class=\"markup--strong markup--p-strong\"\u003e“This is technical debt from an incomplete migration, not an architectural design choice.”\u003c/strong\u003e\u003c/p\u003e\u003cp name=\"2f86\" id=\"2f86\" class=\"graf graf--p graf-after--p\"\u003eThe evidence was clear:\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"d3b2\" id=\"d3b2\" class=\"graf graf--li graf-after--p\"\u003eThe orchestration engine had been fully migrated to the RepositoryFactory pattern\u003c/li\u003e\u003cli name=\"5657\" id=\"5657\" class=\"graf graf--li graf-after--li\"\u003eAPI endpoints had never been migrated from direct imports\u003c/li\u003e\u003cli name=\"3656\" id=\"3656\" class=\"graf graf--li graf-after--li\"\u003eThe two repositories existed because the migration was never completed\u003c/li\u003e\u003c/ul\u003e\u003ch3 name=\"46ff\" id=\"46ff\" class=\"graf graf--h3 graf-after--li\"\u003eThe systematic cleanup begins\u003c/h3\u003e\u003cp name=\"7c3e\" id=\"7c3e\" class=\"graf graf--p graf-after--h3\"\u003eRather than patch around the inconsistencies, we decided to complete the architectural migration properly. The approach: Test-Driven Development for every change, ensuring we didn’t break anything that was working.\u003c/p\u003e\u003ch4 name=\"bc8c\" id=\"bc8c\" class=\"graf graf--h4 graf-after--p\"\u003ePhase 1: FileRepository migration\u003c/h4\u003e\u003cp name=\"0134\" id=\"0134\" class=\"graf graf--p graf-after--h4\"\u003eClaude Code created a comprehensive TDD test suite, then implemented the migration:\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"aab5\" id=\"aab5\" class=\"graf graf--li graf-after--p\"\u003eMigrated from raw SQL to SQLAlchemy ORM\u003c/li\u003e\u003cli name=\"3859\" id=\"3859\" class=\"graf graf--li graf-after--li\"\u003eChanged from connection pools to AsyncSession\u003c/li\u003e\u003cli name=\"0165\" id=\"0165\" class=\"graf graf--li graf-after--li\"\u003eMaintained the same public interface (returns domain models)\u003c/li\u003e\u003cli name=\"dd7a\" id=\"dd7a\" class=\"graf graf--li graf-after--li\"\u003eFollowed Pattern #1 from our architecture documentation\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"2894\" id=\"2894\" class=\"graf graf--p graf-after--li\"\u003eThe migration was clean. The repository now inherited from BaseRepository, used standard patterns, and integrated seamlessly with our test infrastructure.\u003c/p\u003e\u003ch4 name=\"a823\" id=\"a823\" class=\"graf graf--h4 graf-after--p\"\u003ePhase 2: WorkflowRepository consolidation\u003c/h4\u003e\u003cp name=\"11fa\" id=\"11fa\" class=\"graf graf--p graf-after--h4\"\u003eThis was trickier because we needed to preserve functionality for both use cases:\u003c/p\u003e\u003cp name=\"943b\" id=\"943b\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eStep 1\u003c/strong\u003e: Add missing methods to the modern repository\u003c/p\u003e\u003cp name=\"aeb0\" id=\"aeb0\" class=\"graf graf--p graf-after--p\"\u003epython\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"rust\" name=\"4871\" id=\"4871\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003e\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e def \u003cspan class=\"hljs-title function_ invoke__\"\u003efind_by_id\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, workflow_id: \u003cspan class=\"hljs-type\"\u003estr\u003c/span\u003e) \u003cspan class=\"hljs-punctuation\"\u003e-\u0026gt;\u003c/span\u003e Optional[Workflow]:\u003cbr /\u003e    \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026quot;Add legacy method for API compatibility\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\u003cbr /\u003e    db_workflow = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e.\u003cspan class=\"hljs-title function_ invoke__\"\u003eget_by_id\u003c/span\u003e(workflow_id)\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e db_workflow.\u003cspan class=\"hljs-title function_ invoke__\"\u003eto_domain\u003c/span\u003e() \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e db_workflow \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"e1d0\" id=\"e1d0\" class=\"graf graf--p graf-after--pre\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eStep 2\u003c/strong\u003e: Migrate API endpoints to use RepositoryFactory\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"python\" name=\"045e\" id=\"045e\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003e\u003cspan class=\"hljs-comment\"\u003e# Before: Direct import and connection pool\u003c/span\u003e\u003cbr /\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e services.repositories.workflow_repository \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e WorkflowRepository\u003cbr /\u003erepo = WorkflowRepository(pool)\u003cbr /\u003e\u003cbr /\u003e\u003cspan class=\"hljs-comment\"\u003e# After: Factory pattern with session management\u003c/span\u003e\u003cbr /\u003erepos = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e RepositoryFactory.get_repositories()\u003cbr /\u003edb_workflow = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e repos[\u003cspan class=\"hljs-string\"\u003e\u0026quot;workflows\u0026quot;\u003c/span\u003e].find_by_id(workflow_id)\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"61c9\" id=\"61c9\" class=\"graf graf--p graf-after--pre\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eStep 3\u003c/strong\u003e: Remove the legacy implementation entirely\u003c/p\u003e\u003cp name=\"7953\" id=\"7953\" class=\"graf graf--p graf-after--p\"\u003eThe migration was surgical. API functionality remained identical, but now everything used the same underlying patterns and session management.\u003c/p\u003e\u003ch3 name=\"2237\" id=\"2237\" class=\"graf graf--h3 graf-after--p\"\u003eThe async session investigation\u003c/h3\u003e\u003cp name=\"9894\" id=\"9894\" class=\"graf graf--p graf-after--h3\"\u003eWith the repository patterns unified, we still had those mysterious “operation in progress” errors in the FileRepository tests. This led to a deep investigation of async session management that revealed important patterns.\u003c/p\u003e\u003cp name=\"11b1\" id=\"11b1\" class=\"graf graf--p graf-after--p\"\u003eThe error looked like a concurrency issue:\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"csharp\" name=\"09b7\" id=\"09b7\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003esqlalchemy.exc.InterfaceError: cannot perform operation: another operation \u003cspan class=\"hljs-keyword\"\u003eis\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e progress\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"1a4c\" id=\"1a4c\" class=\"graf graf--p graf-after--pre\"\u003eBut systematic testing revealed the infrastructure was sound. We could run 20 sequential operations without issues. The problem was specific test anti-patterns that were reusing sessions inappropriately.\u003c/p\u003e\u003cp name=\"1bc7\" id=\"1bc7\" class=\"graf graf--p graf-after--p\"\u003eThe solution was a session factory pattern for tests:\u003c/p\u003e\u003cpre data-code-block-mode=\"1\" spellcheck=\"false\" data-code-block-lang=\"csharp\" name=\"295c\" id=\"295c\" class=\"graf graf--pre graf-after--p graf--preV2\"\u003e\u003cspan class=\"pre--content\"\u003e\u003cspan class=\"hljs-meta\"\u003e# Anti-pattern: Reusing session in loops\u003c/span\u003e\u003cbr /\u003erepo = FileRepository(db_session)\u003cbr /\u003e\u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e item \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e items:\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e repo.save_file_metadata(item)  \u003cspan class=\"hljs-meta\"\u003e# Session reused!\u003c/span\u003e\u003cbr /\u003e\u003cbr /\u003e\u003cspan class=\"hljs-meta\"\u003e# Better pattern: Fresh session per operation\u003c/span\u003e\u003cbr /\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003edb_session_factory\u003c/span\u003e() \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e session:\u003cbr /\u003e    repo\u003c/span\u003e = FileRepository(session)\u003cbr /\u003e    \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e repo.save_file_metadata(item)\u003c/span\u003e\u003c/pre\u003e\u003cp name=\"ad58\" id=\"ad58\" class=\"graf graf--p graf-after--pre\"\u003eThis investigation taught us important principles about async database testing and session lifecycle management that will prevent similar issues in the future.\u003c/p\u003e\u003ch3 name=\"b8da\" id=\"b8da\" class=\"graf graf--h3 graf-after--p\"\u003eThe moment of architectural victory\u003c/h3\u003e\u003cp name=\"a749\" id=\"a749\" class=\"graf graf--p graf-after--h3\"\u003eBy evening, the audit results were transformed:\u003c/p\u003e\u003cp name=\"6c57\" id=\"6c57\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eRepository Compliance: 100% (7/7 repositories)\u003c/strong\u003e\u003c/p\u003e\u003cul class=\"postList\"\u003e\u003cli name=\"3062\" id=\"3062\" class=\"graf graf--li graf-after--p\"\u003e✅ All repositories inherit from BaseRepository\u003c/li\u003e\u003cli name=\"7abb\" id=\"7abb\" class=\"graf graf--li graf-after--li\"\u003e✅ All repositories use AsyncSession pattern\u003c/li\u003e\u003cli name=\"65b1\" id=\"65b1\" class=\"graf graf--li graf-after--li\"\u003e✅ All repositories follow documented patterns\u003c/li\u003e\u003cli name=\"3347\" id=\"3347\" class=\"graf graf--li graf-after--li\"\u003e✅ No legacy implementations remaining\u003c/li\u003e\u003cli name=\"7b4d\" id=\"7b4d\" class=\"graf graf--li graf-after--li\"\u003e✅ Consistent architectural layers\u003c/li\u003e\u003c/ul\u003e\u003cp name=\"6e8b\" id=\"6e8b\" class=\"graf graf--p graf-after--li\"\u003eWe’d achieved something rare in software development: complete pattern compliance across the entire system. Every repository now follows the same rules, uses the same base classes, and integrates with the same infrastructure.\u003c/p\u003e\u003ch3 name=\"40e8\" id=\"40e8\" class=\"graf graf--h3 graf-after--p\"\u003eThe meta-lessons about technical debt\u003c/h3\u003e\u003cp name=\"346a\" id=\"346a\" class=\"graf graf--p graf-after--h3\"\u003eThe July 14 cleanup taught us several important principles:\u003c/p\u003e\u003cp name=\"ee29\" id=\"ee29\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eLegacy code compounds.\u003c/strong\u003e What started as one non-compliant repository revealed systematic architectural inconsistencies. Technical debt doesn’t stay isolated — it spreads and creates maintenance burden across the system.\u003c/p\u003e\u003cp name=\"6b9b\" id=\"6b9b\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eGood architecture makes debugging easier.\u003c/strong\u003e Once we had consistent patterns, new issues became obvious. When everything follows the same rules, violations stand out immediately.\u003c/p\u003e\u003cp name=\"1a7e\" id=\"1a7e\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eTest failures can be architectural feedback.\u003c/strong\u003e The FileRepository test failures weren’t just broken tests — they were the system telling us about pattern violations we hadn’t noticed.\u003c/p\u003e\u003cp name=\"c6de\" id=\"c6de\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eAI agents excel at systematic audits.\u003c/strong\u003e Having Claude Code comprehensively audit all repository implementations revealed technical debt we might have missed for months. Different AI agents working in parallel (Cursor on session management, Claude Code on pattern compliance) accelerated the cleanup significantly.\u003c/p\u003e\u003ch3 name=\"7d69\" id=\"7d69\" class=\"graf graf--h3 graf-after--p\"\u003eThe collaborative debugging pattern\u003c/h3\u003e\u003cp name=\"d360\" id=\"d360\" class=\"graf graf--p graf-after--h3\"\u003eThe session demonstrated an effective pattern for complex architectural work:\u003c/p\u003e\u003cp name=\"786b\" id=\"786b\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eStrategic AI\u003c/strong\u003e (Opus) provides oversight and ensures architectural consistency\u003c/p\u003e\u003cp name=\"1d78\" id=\"1d78\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eInvestigative AI\u003c/strong\u003e (Claude Code) conducts systematic audits and discovers technical debt\u003c/p\u003e\u003cp name=\"462d\" id=\"462d\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eImplementation AI\u003c/strong\u003e (Cursor) executes migrations with TDD discipline\u003c/p\u003e\u003cp name=\"41ea\" id=\"41ea\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eHuman\u003c/strong\u003e (that’s me!) makes architectural decisions and coordinates the work\u003c/p\u003e\u003cp name=\"bc5c\" id=\"bc5c\" class=\"graf graf--p graf-after--p\"\u003eThis multi-agent approach let us work on different aspects of the same problem simultaneously without conflicts. While Cursor was fixing async session patterns, Claude Code was migrating repository implementations. The parallel work streams accelerated progress significantly.\u003c/p\u003e\u003ch3 name=\"b1d9\" id=\"b1d9\" class=\"graf graf--h3 graf-after--p\"\u003eWhat this enables going forward\u003c/h3\u003e\u003cp name=\"afc8\" id=\"afc8\" class=\"graf graf--p graf-after--h3\"\u003eAchieving 100% pattern compliance isn’t just aesthetic satisfaction — it has practical benefits:\u003c/p\u003e\u003cp name=\"59bc\" id=\"59bc\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eOnboarding new developers\u003c/strong\u003e becomes easier when everything follows the same patterns. No need to learn multiple ways of doing database access.\u003c/p\u003e\u003cp name=\"3500\" id=\"3500\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eAdding new repositories\u003c/strong\u003e is straightforward — inherit from BaseRepository, follow the established pattern, integrate with RepositoryFactory.\u003c/p\u003e\u003cp name=\"d49b\" id=\"d49b\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eTest infrastructure\u003c/strong\u003e works consistently across all components. No special cases or interface mismatches.\u003c/p\u003e\u003cp name=\"8b6a\" id=\"8b6a\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eDebugging database issues\u003c/strong\u003e has clear troubleshooting patterns. When everything uses the same session management, problems are easier to isolate.\u003c/p\u003e\u003cp name=\"5053\" id=\"5053\" class=\"graf graf--p graf-after--p\"\u003e\u003cstrong class=\"markup--strong markup--p-strong\"\u003eArchitectural reviews\u003c/strong\u003e can focus on new patterns rather than cleaning up old inconsistencies.\u003c/p\u003e\u003ch3 name=\"c173\" id=\"c173\" class=\"graf graf--h3 graf-after--p\"\u003eThe honest assessment\u003c/h3\u003e\u003cp name=\"689a\" id=\"689a\" class=\"graf graf--p graf-after--h3\"\u003eWas the system perfect now? Not even close. We still had test assertion drift, float precision issues, and various edge cases to handle. But the foundational patterns were now solid and consistent.\u003c/p\u003e\u003cp name=\"980d\" id=\"980d\" class=\"graf graf--p graf-after--p\"\u003eSometimes architectural work feels like “yak shaving” — endlessly preparing to do the real work. But July 14 proved that systematic cleanup creates compound benefits. Every repository that follows consistent patterns is one less maintenance burden. Every eliminated legacy implementation is cognitive overhead removed.\u003c/p\u003e\u003ch3 name=\"e3ab\" id=\"e3ab\" class=\"graf graf--h3 graf-after--p\"\u003eThe unexpected satisfaction\u003c/h3\u003e\u003cp name=\"1fbf\" id=\"1fbf\" class=\"graf graf--p graf-after--h3\"\u003eThere’s something deeply satisfying about achieving pattern compliance across a complex system. It’s the difference between a codebase that grew organically (with all the inconsistencies that implies) and one that follows coherent principles.\u003c/p\u003e\u003cp name=\"ea51\" id=\"ea51\" class=\"graf graf--p graf-after--p\"\u003eThe FileRepository now looks like every other repository. The WorkflowRepository duplication is eliminated. The test infrastructure works consistently. When you open any database-related file, you know exactly what patterns to expect.\u003c/p\u003e\u003cp name=\"de3e\" id=\"de3e\" class=\"graf graf--p graf-after--p graf--trailing\"\u003eThat consistency pays dividends every time you need to debug, extend, or modify the system.\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e"])</script><script>self.__next_f.push([1,"f:[\"$\",\"$L1a\",null,{\"post\":{\"title\":\"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14\",\"excerpt\":\"\",\"url\":\"/blog/712-713-715-chat\",\"publishedAt\":\"Invalid Date\",\"publishedAtISO\":\"\",\"author\":\"christian crumlish\",\"readingTime\":\"5 min read\",\"tags\":[\"Building in Public\"],\"guid\":\"https://medium.com/building-piper-morgan/2575d3526323\",\"featuredImage\":\"/assets/blog-images/2575d3526323-featured.webp\",\"slug\":\"712-713-715-chat\",\"category\":\"building\",\"workDate\":\"Jul 14, 2025\",\"workDateISO\":\"2025-07-14T00:00:00.000Z\",\"cluster\":\"production-transformation\",\"chatDate\":\"7/12/2025\",\"featured\":false},\"content\":{\"title\":\"From Broken Tests to Perfect Architecture: The Great Cleanup\",\"subtitle\":\"July 14\",\"content\":\"$1b\",\"author\":\"christian crumlish\",\"canonicalLink\":\"\",\"publishedDate\":\"2025-08-04T14:26:31.084Z\",\"filename\":\"2025-08-04_From-Broken-Tests-to-Perfect-Architecture--The-Great-Cleanup-2575d3526323.html\"}}]\n"])</script><script>self.__next_f.push([1,"15:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n11:null\n"])</script><script>self.__next_f.push([1,"1c:I[8175,[],\"IconMark\"]\n"])</script><script>self.__next_f.push([1,"13:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14 | Piper Morgan\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"July 14\"}],[\"$\",\"meta\",\"2\",{\"name\":\"author\",\"content\":\"Christian Crumlish\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"AI,Product Management,Methodology,Building in Public\"}],[\"$\",\"meta\",\"4\",{\"name\":\"creator\",\"content\":\"Christian Crumlish\"}],[\"$\",\"meta\",\"5\",{\"name\":\"publisher\",\"content\":\"Christian Crumlish\"}],[\"$\",\"meta\",\"6\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"7\",{\"name\":\"googlebot\",\"content\":\"index, follow\"}],[\"$\",\"link\",\"8\",{\"rel\":\"canonical\",\"href\":\"https://pipermorgan.ai/\"}],[\"$\",\"meta\",\"9\",{\"name\":\"format-detection\",\"content\":\"telephone=no, address=no, email=no\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:title\",\"content\":\"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:description\",\"content\":\"July 14\"}],[\"$\",\"meta\",\"12\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"13\",{\"property\":\"article:author\",\"content\":\"christian crumlish\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:title\",\"content\":\"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14\"}],[\"$\",\"meta\",\"16\",{\"name\":\"twitter:description\",\"content\":\"July 14\"}],[\"$\",\"link\",\"17\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"32x33\"}],[\"$\",\"link\",\"18\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"sizes\":\"32x32\",\"type\":\"image/x-icon\"}],[\"$\",\"link\",\"19\",{\"rel\":\"icon\",\"href\":\"/pm-favicon-16.png\",\"sizes\":\"16x16\",\"type\":\"image/png\"}],[\"$\",\"link\",\"20\",{\"rel\":\"icon\",\"href\":\"/pm-favicon-32.png\",\"sizes\":\"32x32\",\"type\":\"image/png\"}],[\"$\",\"link\",\"21\",{\"rel\":\"icon\",\"href\":\"/pm-favicon-48.png\",\"sizes\":\"48x48\",\"type\":\"image/png\"}],[\"$\",\"link\",\"22\",{\"rel\":\"apple-touch-icon\",\"href\":\"/pm-favicon-180.png\",\"sizes\":\"180x180\",\"type\":\"image/png\"}],[\"$\",\"link\",\"23\",{\"rel\":\"icon\",\"href\":\"/pm-favicon-192.png\",\"sizes\":\"192x192\",\"type\":\"image/png\"}],[\"$\",\"$L1c\",\"24\",{}]],\"error\":null,\"digest\":\"$undefined\"}\n"])</script><script>self.__next_f.push([1,"18:\"$13:metadata\"\n"])</script></body></html>
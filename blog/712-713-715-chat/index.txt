1:"$Sreact.fragment"
8:I[8393,[],""]
:HL["/_next/static/css/f9342e94655f11e9.css","style"]
2:T1313,
            :root{--primary-teal:#2DD4BF;--primary-teal-text:#0D9488;--text-dark:#1F2937;--text-light:#6B7280;--background:#FFFFFF;--surface:#F9FAFB}
            .dark{--text-dark:#F1F5F9;--text-light:#94A3B8;--background:#0F172A;--surface:#1E293B}
            @font-face{font-family:'Inter';src:url('/fonts/inter-latin.woff2') format('woff2');font-weight:100 900;font-style:normal;font-display:swap;unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}
            *{box-sizing:border-box}
            html{scroll-behavior:smooth;font-size:16px;margin:0;padding:0;border:none;outline:none}
            body{background:var(--background);color:var(--text-dark);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;line-height:1.6;margin:0;padding:0;border:none;outline:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
            nav{border:none !important;outline:none !important}
            h1,h2,h3,h4,h5,h6{font-family:'Hoss Round','Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
            p,span{max-width:75ch;line-height:1.7}
            .text-content div{max-width:75ch;line-height:1.7}
            .text-content{max-width:65ch}
            @media (max-width:640px){
              h1{font-size:1.75rem;line-height:1.2}
              h2{font-size:1.25rem;line-height:1.3}
              h3{font-size:1.1rem;line-height:1.4}
              h4{font-size:1rem;line-height:1.4}
            }
            @media (min-width:641px) and (max-width:768px){
              h1{font-size:2rem;line-height:1.2}
              h2{font-size:1.5rem;line-height:1.3}
              h3{font-size:1.25rem;line-height:1.4}
            }
            @media (prefers-reduced-motion: reduce){
              *{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important}
            }
            a:hover{color:#0D9488;transition:color 0.2s ease}
            .hover-lift:hover{transform:translateY(-2px);transition:transform 0.2s ease}
            button:focus,a:focus{outline:2px solid #2DD4BF;outline-offset:2px;border-radius:4px}
            .skip-to-content{position:absolute;top:-100px;left:0;z-index:999;padding:8px 16px;background:#1F2937;color:white;text-decoration:none;border-radius:0 0 4px 0;transition:top 0.3s}
            .skip-to-content:focus{top:0;outline:2px solid #2DD4BF;outline-offset:2px}
            .section-spacing{margin-bottom:4rem}
            .component-spacing{margin-bottom:1.5rem}
            .micro-spacing{margin-bottom:0.5rem}
            @media (min-width:768px){
              .section-spacing{margin-bottom:6rem}
              .component-spacing{margin-bottom:2rem}
            }
            .site-container{width:100%;max-width:1200px;margin-left:auto;margin-right:auto;padding-left:1rem;padding-right:1rem}
            @media (min-width:640px){.site-container{padding-left:1.5rem;padding-right:1.5rem}}
            @media (min-width:768px){.site-container{padding-left:2rem;padding-right:2rem}}
            @media (min-width:1024px){.site-container{max-width:1200px}}
            @media (min-width:1200px){.site-container{max-width:1200px}}
            .section-padding{padding-top:4rem;padding-bottom:4rem}
            @media (min-width:768px){.section-padding{padding-top:5rem;padding-bottom:5rem}}
            .mx-auto{margin-left:auto;margin-right:auto}
            .max-w-4xl{max-width:56rem}
            .pt-16{padding-top:4rem}
            .pb-8{padding-bottom:2rem}
            .px-4{padding-left:1rem;padding-right:1rem}
            .mb-6{margin-bottom:1.5rem}
            .mb-8{margin-bottom:2rem}
            .text-left{text-align:left}
            .text-center{text-align:center}
            .text-primary-teal-text{color:#0F766E}
            .text-text-dark{color:#1F2937}
            .text-text-light{color:#6B7280}
            .font-bold{font-weight:700}
            .text-4xl{font-size:2.25rem;line-height:2.5rem}
            .text-5xl{font-size:3rem;line-height:1}
            .text-6xl{font-size:3.75rem;line-height:1}
            .text-lg{font-size:1.125rem;line-height:1.75rem}
            .text-xl{font-size:1.25rem;line-height:1.75rem}
            .leading-tight{line-height:1.25}
            .leading-relaxed{line-height:1.625}
            .min-h-screen{min-height:100vh}
            @media (min-width:768px){
              .md\:pt-24{padding-top:6rem}
              .md\:pb-12{padding-bottom:3rem}
              .md\:text-5xl{font-size:3rem;line-height:1}
              .md\:text-xl{font-size:1.25rem;line-height:1.75rem}
            }
            @media (min-width:1024px){
              .lg\:text-6xl{font-size:3.75rem;line-height:1}
            }
          0:{"P":null,"b":"e1iNoATfzAzRWVyCzcdAg","p":"","c":["","blog","712-713-715-chat",""],"i":false,"f":[[["",{"children":["blog",{"children":[["slug","712-713-715-chat","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/f9342e94655f11e9.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"font-inter","children":[["$","head",null,{"children":[["$","script",null,{"dangerouslySetInnerHTML":{"__html":"\n              (function() {\n                const theme = localStorage.getItem('theme') ||\n                  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');\n                if (theme === 'dark') {\n                  document.documentElement.classList.add('dark');\n                  document.body.classList.add('dark');\n                }\n              })();\n            "}}],["$","link",null,{"rel":"dns-prefetch","href":"//pipermorgan.ai"}],["$","link",null,{"rel":"preconnect","href":"https://pipermorgan.ai"}],["$","link",null,{"rel":"preload","as":"image","href":"/assets/pm-logo.png"}],["$","link",null,{"rel":"preload","href":"/fonts/inter-latin.woff2","as":"font","type":"font/woff2","crossOrigin":"anonymous"}],["$","link",null,{"rel":"preload","href":"/fonts/HossRound-Regular.woff2","as":"font","type":"font/woff2","crossOrigin":"anonymous"}],["$","style",null,{"dangerouslySetInnerHTML":{"__html":"$2"}}]]}],"$L3"]}]]}],{"children":["blog","$L4",{"children":[["slug","712-713-715-chat","d"],"$L5",{"children":["__PAGE__","$L6",{},null,false]},null,false]},null,false]},null,false],"$L7",false]],"m":"$undefined","G":["$8",[]],"s":false,"S":true}
9:I[9119,["874","static/chunks/874-668c89038fa04eb8.js","212","static/chunks/212-369ef96a260e510f.js","177","static/chunks/app/layout-9ed54623e803ece8.js"],"ClientLayout"]
a:I[7555,[],""]
b:I[1295,[],""]
c:I[6874,["874","static/chunks/874-668c89038fa04eb8.js","212","static/chunks/212-369ef96a260e510f.js","144","static/chunks/144-1b443e029a921717.js","674","static/chunks/674-8e17e7c3bb7de472.js","831","static/chunks/app/blog/page-666765c672eae567.js"],""]
10:I[9665,[],"OutletBoundary"]
12:I[4911,[],"AsyncMetadataOutlet"]
14:I[9665,[],"ViewportBoundary"]
16:I[9665,[],"MetadataBoundary"]
17:"$Sreact.suspense"
3:["$","body",null,{"className":"font-sans antialiased","children":[["$","$L9",null,{"children":["$","$La",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$Lb",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"min-h-screen","children":["$","div",null,{"className":"site-container max-w-4xl pt-16 md:pt-24 pb-8 md:pb-12 text-center","children":[["$","div",null,{"className":"mb-8","children":[["$","h1",null,{"className":"text-8xl md:text-9xl font-bold text-primary-teal-text mb-4","children":"404"}],["$","h2",null,{"className":"text-3xl md:text-4xl font-semibold text-text-dark mb-4","children":"Page Not Found"}],["$","p",null,{"className":"text-xl text-text-light leading-relaxed max-w-2xl mx-auto","children":"Looks like this page got lost in the AI training data. Don't worry ‚Äì even the best algorithms make mistakes sometimes."}]]}],["$","div",null,{"className":"mb-12","children":[["$","h3",null,{"className":"text-xl font-semibold text-text-dark mb-6","children":"Where would you like to go instead?"}],["$","div",null,{"className":"grid md:grid-cols-2 gap-6 max-w-2xl mx-auto","children":[["$","div",null,{"className":"space-y-4","children":[["$","$Lc",null,{"href":"/","className":"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group","children":[["$","h4",null,{"className":"font-semibold text-text-dark group-hover:text-primary-teal-text","children":"üè† Homepage"}],["$","p",null,{"className":"text-sm text-text-light mt-1","children":"Start from the beginning of our AI PM journey"}]]}],["$","$Lc",null,{"href":"/how-it-works","className":"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group","children":[["$","h4",null,{"className":"font-semibold text-text-dark group-hover:text-primary-teal-text","children":"‚öôÔ∏è How It Works"}],["$","p",null,{"className":"text-sm text-text-light mt-1","children":"Discover our AI-powered product management methodology"}]]}]]}],["$","div",null,{"className":"space-y-4","children":[["$","$Lc",null,{"href":"/what-weve-learned","className":"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group","children":[["$","h4",null,{"className":"font-semibold text-text-dark group-hover:text-primary-teal-text","children":"üí° What We've Learned"}],["$","p",null,{"className":"text-sm text-text-light mt-1","children":"Building-in-public insights and breakthroughs"}]]}],["$","$Lc",null,{"href":"/blog","className":"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group","children":[["$","h4",null,{"className":"font-semibold text-text-dark group-hover:text-primary-teal-text","children":"üìù Journey"}],["$","p",null,{"className":"text-sm text-text-light mt-1","children":"Follow our building-in-public blog posts"}]]}],["$","$Lc",null,{"href":"/get-involved","className":"block p-4 bg-surface rounded-card hover:bg-gray-50 transition-colors group","children":[["$","h4",null,{"className":"font-semibold text-text-dark group-hover:text-primary-teal-text","children":"üöÄ Get Involved"}],["$","p",null,{"className":"text-sm text-text-light mt-1","children":"Join our community and stay updated"}]]}]]}]]}]]}],["$","div",null,{"className":"text-center","children":[["$","p",null,{"className":"text-text-light mb-6","children":"Still can't find what you're looking for?"}],["$","$Lc",null,{"href":"/get-involved","className":"inline-flex items-center justify-center font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none bg-primary-teal text-white hover:bg-teal-600 focus:ring-primary-teal shadow-component hover:shadow-component-hover hover:-translate-y-0.5 hover:scale-105 font-bold text-lg px-8 py-4 text-lg rounded-button","aria-label":"$undefined","children":[false,"Get Help & Stay Updated"]}]]}],["$","div",null,{"className":"mt-12 p-6 bg-gray-50 rounded-card max-w-lg mx-auto","children":["$","p",null,{"className":"text-sm text-text-light italic","children":["üí¨ ","$Ld"," \"Even the most sophisticated neural networks occasionally return null. Let's navigate back to more productive paths together!\""]}]}]]}]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],"$Le"]}]
4:["$","$1","c",{"children":[null,["$","$La",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$Lb",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}]
5:["$","$1","c",{"children":[null,["$","$La",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$Lb",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}]
6:["$","$1","c",{"children":["$Lf",null,["$","$L10",null,{"children":["$L11",["$","$L12",null,{"promise":"$@13"}]]}]]}]
7:["$","$1","h",{"children":[null,[["$","$L14",null,{"children":"$L15"}],null],["$","$L16",null,{"children":["$","div",null,{"hidden":true,"children":["$","$17",null,{"fallback":null,"children":"$L18"}]}]}]]}]
19:I[9795,["874","static/chunks/874-668c89038fa04eb8.js","212","static/chunks/212-369ef96a260e510f.js","177","static/chunks/app/layout-9ed54623e803ece8.js"],"default"]
d:["$","strong",null,{"children":"Piper Morgan says:"}]
e:["$","$L19",null,{}]
1a:I[7887,["874","static/chunks/874-668c89038fa04eb8.js","953","static/chunks/app/blog/%5Bslug%5D/page-63f1c4c60df8aece.js"],"BlogPostContent"]
1b:T62fc,<section name="58ba" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="4c57" id="4c57" class="graf graf--h3 graf--leading graf--title">From Broken Tests to Perfect Architecture: The Great¬†Cleanup</h3><figure name="94f4" id="94f4" class="graf graf--figure graf--startsWithDoubleQuote graf-after--h3"><img class="graf-image" data-image-id="1*gt2lNbkYQVHRL5JZCpHaNg.png" data-width="1536" data-height="1024" data-is-featured="true" alt="A person and a robot clean up a house that was hit by a hurricane" src="https://cdn-images-1.medium.com/max/800/1*gt2lNbkYQVHRL5JZCpHaNg.png"><figcaption class="imageCaption">‚ÄúWe‚Äôll make it better than¬†new‚Äù</figcaption></figure><p name="b43a" id="b43a" class="graf graf--p graf-after--figure"><em class="markup--em markup--p-em">July 14</em></p><p name="9ca2" id="9ca2" class="graf graf--p graf--hasDropCapModel graf--hasDropCap graf-after--p"><span class="graf-dropCap">W</span>hat started as ‚Äúlet‚Äôs fix these 9 failing FileRepository tests‚Äù became ‚Äúlet‚Äôs eliminate three years‚Äìworth of accumulated technical debt and achieve 100% architectural pattern compliance.‚Äù Sometimes the best debugging sessions are the ones that refuse to stay in their lane.</p><p name="0537" id="0537" class="graf graf--p graf-after--p">(How we accumulated that much tech debt in less than three weeks is another testament to the power of AI.)</p><p name="737f" id="737f" class="graf graf--p graf-after--p">Eventually, we discovered that our test failures weren‚Äôt just broken tests‚Ää‚Äî‚Ääthey were symptoms of fundamental architectural inconsistencies that had been lurking beneath a mostly-working system. By the end of a 14-hour session, we‚Äôd eliminated dual repository implementations, standardized on consistent patterns, and achieved something every architect dreams of: a codebase where everything follows the same rules.</p><h3 name="752a" id="752a" class="graf graf--h3 graf-after--p">The deceptively simple starting¬†point</h3><p name="1c40" id="1c40" class="graf graf--p graf-after--h3">Fresh off PM-011‚Äôs completion and the test suite recovery to 87% pass rate, I thought July 14 would be a cleanup day. Just 27 remaining test failures across a few categories:</p><ul class="postList"><li name="9f78" id="9f78" class="graf graf--li graf-after--p">9 FileRepository tests (connection pool vs session mismatch)</li><li name="f3fd" id="f3fd" class="graf graf--li graf-after--li">3 API query tests (session management issues)</li><li name="265b" id="265b" class="graf graf--li graf-after--li">14 assertion drift tests (float precision, logic updates)</li><li name="43c7" id="43c7" class="graf graf--li graf-after--li">1 miscellaneous test (dataclass issue)</li></ul><p name="54d4" id="54d4" class="graf graf--p graf-after--li">The FileRepository failures looked straightforward: tests were providing AsyncSession objects, but the repository expected connection pools with an¬†<code class="markup--code markup--p-code">.acquire()</code> method. Classic interface mismatch. Should be a quick fix, right?</p><p name="fd00" id="fd00" class="graf graf--p graf-after--p">Famous last words.</p><h3 name="bfdd" id="bfdd" class="graf graf--h3 graf-after--p">The revealing architectural audit</h3><p name="3697" id="3697" class="graf graf--p graf-after--h3">Instead of band-aiding the FileRepository issue, I asked Claude Code to investigate our database patterns more systematically. What came back was a comprehensive architectural compliance audit that revealed uncomfortable truths about our codebase.</p><p name="1a6e" id="1a6e" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Repository Compliance: 71% (5/7 repositories)</strong></p><p name="36b0" id="36b0" class="graf graf--p graf-after--p">The audit identified seven repositories across the system:</p><ul class="postList"><li name="e3e9" id="e3e9" class="graf graf--li graf-after--p">‚úÖ 5 repositories fully compliant with our documented Pattern #1</li><li name="ee46" id="ee46" class="graf graf--li graf-after--li">‚ùå 1 repository using legacy raw SQL + connection pools</li><li name="6800" id="6800" class="graf graf--li graf-after--li">‚ö†Ô∏è 1 repository in the wrong architectural layer</li></ul><p name="4194" id="4194" class="graf graf--p graf-after--li">But the real shock was the footnote: <strong class="markup--strong markup--p-strong">‚ÄúDual WorkflowRepository implementation detected.‚Äù</strong></p><p name="bb12" id="bb12" class="graf graf--p graf-after--p">We had two completely different WorkflowRepository classes in the codebase. Not variations on a theme‚Ää‚Äî‚Ääcompletely different implementations using different patterns, serving different parts of the system. (I was getting d√©j√† vu again. Why did we keep ‚Äúdiscovering‚Äù that we‚Äôd built parallel solutions in the past?)</p><h3 name="b686" id="b686" class="graf graf--h3 graf-after--p">The detective work¬†begins</h3><p name="f321" id="f321" class="graf graf--p graf-after--h3">The FileRepository investigation led to a broader question: how much legacy code were we carrying from before we established architectural patterns?</p><p name="6ae0" id="6ae0" class="graf graf--p graf-after--p">Claude Code‚Äôs analysis revealed the scope:</p><p name="0583" id="0583" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Legacy Pattern (Raw SQL + Connection Pools):</strong></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="python" name="2dab" id="2dab" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRepository</span>:<br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, db_pool</span>):<br />        self.db_pool = db_pool<br />    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_by_id</span>(<span class="hljs-params">self, file_id: <span class="hljs-built_in">str</span></span>):<br />        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.db_pool.acquire() <span class="hljs-keyword">as</span> conn:<br />            row = <span class="hljs-keyword">await</span> conn.fetchrow(<span class="hljs-string">&quot;SELECT * FROM uploaded_files WHERE id = $1&quot;</span>, file_id)</span></pre><p name="5d3a" id="5d3a" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Modern Pattern (SQLAlchemy + Sessions):</strong></p><p name="5182" id="5182" class="graf graf--p graf-after--p">python</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="ruby" name="d2e6" id="d2e6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRepository</span>(<span class="hljs-title class_">BaseRepository</span>):<br />    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, <span class="hljs-symbol">session:</span> <span class="hljs-title class_">AsyncSession</span></span>):<br />        <span class="hljs-variable language_">super</span>().__init__(session, <span class="hljs-title class_">UploadedFile</span>DB)<br />    async <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_by_id</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, <span class="hljs-symbol">file_id:</span> str</span>) -&gt; <span class="hljs-title class_">Optional</span>[<span class="hljs-title class_">UploadedFile</span>]:<br />        result = await <span class="hljs-variable language_">self</span>.session.execute(<br />            select(<span class="hljs-title class_">UploadedFile</span>DB).where(<span class="hljs-title class_">UploadedFile</span>DB.id == file_id)<br />        )</span></pre><p name="f33f" id="f33f" class="graf graf--p graf-after--pre">The FileRepository was essentially prototype code that had never been migrated to our documented patterns. It worked, but it violated every architectural principle we‚Äôd established.</p><p name="3ffc" id="3ffc" class="graf graf--p graf-after--p">Suddenly, I was having nightmares again about the legacy spaghetti that powered AOL Instant Messenger in its final days.</p><h3 name="49b9" id="49b9" class="graf graf--h3 graf-after--p">The dual WorkflowRepository mystery</h3><p name="c9db" id="c9db" class="graf graf--p graf-after--h3">The WorkflowRepository situation was more complex. We had two implementations:</p><p name="e8a1" id="e8a1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Legacy version</strong> (<code class="markup--code markup--p-code">services/repositories/workflow_repository.py</code>):</p><ul class="postList"><li name="5495" id="5495" class="graf graf--li graf-after--p">Raw SQL with connection pools</li><li name="1c59" id="1c59" class="graf graf--li graf-after--li">Used by API endpoints for read operations</li><li name="b4a0" id="b4a0" class="graf graf--li graf-after--li">Methods: <code class="markup--code markup--li-code">find_by_id()</code>, <code class="markup--code markup--li-code">save()</code></li></ul><p name="400b" id="400b" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">Modern version</strong> (<code class="markup--code markup--p-code">services/database/repositories.py</code>):</p><ul class="postList"><li name="6fa3" id="6fa3" class="graf graf--li graf-after--p">Inherits from BaseRepository</li><li name="06ee" id="06ee" class="graf graf--li graf-after--li">Used by orchestration engine for write operations</li><li name="7598" id="7598" class="graf graf--li graf-after--li">Methods: <code class="markup--code markup--li-code">create_from_domain()</code>, <code class="markup--code markup--li-code">update_status()</code></li></ul><p name="7c64" id="7c64" class="graf graf--p graf-after--li">The interfaces didn‚Äôt even overlap! They were serving completely different use cases, with no obvious conflicts. This explained why the duplication had persisted‚Ää‚Äî‚Ääeach implementation worked perfectly for its specific purpose.</p><p name="f49a" id="f49a" class="graf graf--p graf-after--p">But Claude Code‚Äôs investigation revealed the truth: <strong class="markup--strong markup--p-strong">‚ÄúThis is technical debt from an incomplete migration, not an architectural design choice.‚Äù</strong></p><p name="2f86" id="2f86" class="graf graf--p graf-after--p">The evidence was clear:</p><ul class="postList"><li name="d3b2" id="d3b2" class="graf graf--li graf-after--p">The orchestration engine had been fully migrated to the RepositoryFactory pattern</li><li name="5657" id="5657" class="graf graf--li graf-after--li">API endpoints had never been migrated from direct imports</li><li name="3656" id="3656" class="graf graf--li graf-after--li">The two repositories existed because the migration was never completed</li></ul><h3 name="46ff" id="46ff" class="graf graf--h3 graf-after--li">The systematic cleanup¬†begins</h3><p name="7c3e" id="7c3e" class="graf graf--p graf-after--h3">Rather than patch around the inconsistencies, we decided to complete the architectural migration properly. The approach: Test-Driven Development for every change, ensuring we didn‚Äôt break anything that was working.</p><h4 name="bc8c" id="bc8c" class="graf graf--h4 graf-after--p">Phase 1: FileRepository migration</h4><p name="0134" id="0134" class="graf graf--p graf-after--h4">Claude Code created a comprehensive TDD test suite, then implemented the migration:</p><ul class="postList"><li name="aab5" id="aab5" class="graf graf--li graf-after--p">Migrated from raw SQL to SQLAlchemy ORM</li><li name="3859" id="3859" class="graf graf--li graf-after--li">Changed from connection pools to AsyncSession</li><li name="0165" id="0165" class="graf graf--li graf-after--li">Maintained the same public interface (returns domain models)</li><li name="dd7a" id="dd7a" class="graf graf--li graf-after--li">Followed Pattern #1 from our architecture documentation</li></ul><p name="2894" id="2894" class="graf graf--p graf-after--li">The migration was clean. The repository now inherited from BaseRepository, used standard patterns, and integrated seamlessly with our test infrastructure.</p><h4 name="a823" id="a823" class="graf graf--h4 graf-after--p">Phase 2: WorkflowRepository consolidation</h4><p name="11fa" id="11fa" class="graf graf--p graf-after--h4">This was trickier because we needed to preserve functionality for both use cases:</p><p name="943b" id="943b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Step 1</strong>: Add missing methods to the modern repository</p><p name="aeb0" id="aeb0" class="graf graf--p graf-after--p">python</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="rust" name="4871" id="4871" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">async</span> def <span class="hljs-title function_ invoke__">find_by_id</span>(<span class="hljs-keyword">self</span>, workflow_id: <span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> Optional[Workflow]:<br />    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;Add legacy method for API compatibility&quot;</span><span class="hljs-string">&quot;&quot;</span><br />    db_workflow = <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_by_id</span>(workflow_id)<br />    <span class="hljs-keyword">return</span> db_workflow.<span class="hljs-title function_ invoke__">to_domain</span>() <span class="hljs-keyword">if</span> db_workflow <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span></span></pre><p name="e1d0" id="e1d0" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Step 2</strong>: Migrate API endpoints to use RepositoryFactory</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="python" name="045e" id="045e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment"># Before: Direct import and connection pool</span><br /><span class="hljs-keyword">from</span> services.repositories.workflow_repository <span class="hljs-keyword">import</span> WorkflowRepository<br />repo = WorkflowRepository(pool)<br /><br /><span class="hljs-comment"># After: Factory pattern with session management</span><br />repos = <span class="hljs-keyword">await</span> RepositoryFactory.get_repositories()<br />db_workflow = <span class="hljs-keyword">await</span> repos[<span class="hljs-string">&quot;workflows&quot;</span>].find_by_id(workflow_id)</span></pre><p name="61c9" id="61c9" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Step 3</strong>: Remove the legacy implementation entirely</p><p name="7953" id="7953" class="graf graf--p graf-after--p">The migration was surgical. API functionality remained identical, but now everything used the same underlying patterns and session management.</p><h3 name="2237" id="2237" class="graf graf--h3 graf-after--p">The async session investigation</h3><p name="9894" id="9894" class="graf graf--p graf-after--h3">With the repository patterns unified, we still had those mysterious ‚Äúoperation in progress‚Äù errors in the FileRepository tests. This led to a deep investigation of async session management that revealed important patterns.</p><p name="11b1" id="11b1" class="graf graf--p graf-after--p">The error looked like a concurrency issue:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="09b7" id="09b7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">sqlalchemy.exc.InterfaceError: cannot perform operation: another operation <span class="hljs-keyword">is</span> <span class="hljs-keyword">in</span> progress</span></pre><p name="1a4c" id="1a4c" class="graf graf--p graf-after--pre">But systematic testing revealed the infrastructure was sound. We could run 20 sequential operations without issues. The problem was specific test anti-patterns that were reusing sessions inappropriately.</p><p name="1bc7" id="1bc7" class="graf graf--p graf-after--p">The solution was a session factory pattern for tests:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="295c" id="295c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta"># Anti-pattern: Reusing session in loops</span><br />repo = FileRepository(db_session)<br /><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:<br />    <span class="hljs-keyword">await</span> repo.save_file_metadata(item)  <span class="hljs-meta"># Session reused!</span><br /><br /><span class="hljs-meta"># Better pattern: Fresh session per operation</span><br /><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">await</span> <span class="hljs-title">db_session_factory</span>() <span class="hljs-keyword">as</span> session:<br />    repo</span> = FileRepository(session)<br />    <span class="hljs-keyword">await</span> repo.save_file_metadata(item)</span></pre><p name="ad58" id="ad58" class="graf graf--p graf-after--pre">This investigation taught us important principles about async database testing and session lifecycle management that will prevent similar issues in the future.</p><h3 name="b8da" id="b8da" class="graf graf--h3 graf-after--p">The moment of architectural victory</h3><p name="a749" id="a749" class="graf graf--p graf-after--h3">By evening, the audit results were transformed:</p><p name="6c57" id="6c57" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Repository Compliance: 100% (7/7 repositories)</strong></p><ul class="postList"><li name="3062" id="3062" class="graf graf--li graf-after--p">‚úÖ All repositories inherit from BaseRepository</li><li name="7abb" id="7abb" class="graf graf--li graf-after--li">‚úÖ All repositories use AsyncSession pattern</li><li name="65b1" id="65b1" class="graf graf--li graf-after--li">‚úÖ All repositories follow documented patterns</li><li name="3347" id="3347" class="graf graf--li graf-after--li">‚úÖ No legacy implementations remaining</li><li name="7b4d" id="7b4d" class="graf graf--li graf-after--li">‚úÖ Consistent architectural layers</li></ul><p name="6e8b" id="6e8b" class="graf graf--p graf-after--li">We‚Äôd achieved something rare in software development: complete pattern compliance across the entire system. Every repository now follows the same rules, uses the same base classes, and integrates with the same infrastructure.</p><h3 name="40e8" id="40e8" class="graf graf--h3 graf-after--p">The meta-lessons about technical debt</h3><p name="346a" id="346a" class="graf graf--p graf-after--h3">The July 14 cleanup taught us several important principles:</p><p name="ee29" id="ee29" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Legacy code compounds.</strong> What started as one non-compliant repository revealed systematic architectural inconsistencies. Technical debt doesn‚Äôt stay isolated‚Ää‚Äî‚Ääit spreads and creates maintenance burden across the system.</p><p name="6b9b" id="6b9b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Good architecture makes debugging easier.</strong> Once we had consistent patterns, new issues became obvious. When everything follows the same rules, violations stand out immediately.</p><p name="1a7e" id="1a7e" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Test failures can be architectural feedback.</strong> The FileRepository test failures weren‚Äôt just broken tests‚Ää‚Äî‚Ääthey were the system telling us about pattern violations we hadn‚Äôt noticed.</p><p name="c6de" id="c6de" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">AI agents excel at systematic audits.</strong> Having Claude Code comprehensively audit all repository implementations revealed technical debt we might have missed for months. Different AI agents working in parallel (Cursor on session management, Claude Code on pattern compliance) accelerated the cleanup significantly.</p><h3 name="7d69" id="7d69" class="graf graf--h3 graf-after--p">The collaborative debugging pattern</h3><p name="d360" id="d360" class="graf graf--p graf-after--h3">The session demonstrated an effective pattern for complex architectural work:</p><p name="786b" id="786b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Strategic AI</strong> (Opus) provides oversight and ensures architectural consistency</p><p name="1d78" id="1d78" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Investigative AI</strong> (Claude Code) conducts systematic audits and discovers technical debt</p><p name="462d" id="462d" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Implementation AI</strong> (Cursor) executes migrations with TDD discipline</p><p name="41ea" id="41ea" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Human</strong> (that‚Äôs me!) makes architectural decisions and coordinates the work</p><p name="bc5c" id="bc5c" class="graf graf--p graf-after--p">This multi-agent approach let us work on different aspects of the same problem simultaneously without conflicts. While Cursor was fixing async session patterns, Claude Code was migrating repository implementations. The parallel work streams accelerated progress significantly.</p><h3 name="b1d9" id="b1d9" class="graf graf--h3 graf-after--p">What this enables going¬†forward</h3><p name="afc8" id="afc8" class="graf graf--p graf-after--h3">Achieving 100% pattern compliance isn‚Äôt just aesthetic satisfaction‚Ää‚Äî‚Ääit has practical benefits:</p><p name="59bc" id="59bc" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Onboarding new developers</strong> becomes easier when everything follows the same patterns. No need to learn multiple ways of doing database access.</p><p name="3500" id="3500" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Adding new repositories</strong> is straightforward‚Ää‚Äî‚Ääinherit from BaseRepository, follow the established pattern, integrate with RepositoryFactory.</p><p name="d49b" id="d49b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Test infrastructure</strong> works consistently across all components. No special cases or interface mismatches.</p><p name="8b6a" id="8b6a" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Debugging database issues</strong> has clear troubleshooting patterns. When everything uses the same session management, problems are easier to isolate.</p><p name="5053" id="5053" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Architectural reviews</strong> can focus on new patterns rather than cleaning up old inconsistencies.</p><h3 name="c173" id="c173" class="graf graf--h3 graf-after--p">The honest assessment</h3><p name="689a" id="689a" class="graf graf--p graf-after--h3">Was the system perfect now? Not even close. We still had test assertion drift, float precision issues, and various edge cases to handle. But the foundational patterns were now solid and consistent.</p><p name="980d" id="980d" class="graf graf--p graf-after--p">Sometimes architectural work feels like ‚Äúyak shaving‚Äù‚Ää‚Äî‚Ääendlessly preparing to do the real work. But July 14 proved that systematic cleanup creates compound benefits. Every repository that follows consistent patterns is one less maintenance burden. Every eliminated legacy implementation is cognitive overhead removed.</p><h3 name="e3ab" id="e3ab" class="graf graf--h3 graf-after--p">The unexpected satisfaction</h3><p name="1fbf" id="1fbf" class="graf graf--p graf-after--h3">There‚Äôs something deeply satisfying about achieving pattern compliance across a complex system. It‚Äôs the difference between a codebase that grew organically (with all the inconsistencies that implies) and one that follows coherent principles.</p><p name="ea51" id="ea51" class="graf graf--p graf-after--p">The FileRepository now looks like every other repository. The WorkflowRepository duplication is eliminated. The test infrastructure works consistently. When you open any database-related file, you know exactly what patterns to expect.</p><p name="de3e" id="de3e" class="graf graf--p graf-after--p graf--trailing">That consistency pays dividends every time you need to debug, extend, or modify the system.</p></div></div>f:["$","$L1a",null,{"post":{"title":"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14","excerpt":"","url":"/blog/712-713-715-chat","publishedAt":"Invalid Date","publishedAtISO":"","author":"christian crumlish","readingTime":"5 min read","tags":["Building in Public"],"guid":"https://medium.com/building-piper-morgan/2575d3526323","featuredImage":"/assets/blog-images/2575d3526323-featured.webp","slug":"712-713-715-chat","category":"building","workDate":"Jul 14, 2025","workDateISO":"2025-07-14T00:00:00.000Z","cluster":"production-transformation","chatDate":"7/12/2025","featured":false},"content":{"title":"From Broken Tests to Perfect Architecture: The Great Cleanup","subtitle":"July 14","content":"$1b","author":"christian crumlish","canonicalLink":"","publishedDate":"2025-08-04T14:26:31.084Z","filename":"2025-08-04_From-Broken-Tests-to-Perfect-Architecture--The-Great-Cleanup-2575d3526323.html"}}]
15:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
11:null
1c:I[8175,[],"IconMark"]
13:{"metadata":[["$","title","0",{"children":"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14 | Piper Morgan"}],["$","meta","1",{"name":"description","content":"July 14"}],["$","meta","2",{"name":"author","content":"Christian Crumlish"}],["$","meta","3",{"name":"keywords","content":"AI,Product Management,Methodology,Building in Public"}],["$","meta","4",{"name":"creator","content":"Christian Crumlish"}],["$","meta","5",{"name":"publisher","content":"Christian Crumlish"}],["$","meta","6",{"name":"robots","content":"index, follow"}],["$","meta","7",{"name":"googlebot","content":"index, follow"}],["$","link","8",{"rel":"canonical","href":"https://pipermorgan.ai/"}],["$","meta","9",{"name":"format-detection","content":"telephone=no, address=no, email=no"}],["$","meta","10",{"property":"og:title","content":"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14"}],["$","meta","11",{"property":"og:description","content":"July 14"}],["$","meta","12",{"property":"og:type","content":"article"}],["$","meta","13",{"property":"article:author","content":"christian crumlish"}],["$","meta","14",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","15",{"name":"twitter:title","content":"7/12-7/13, 7/15 chat: From Broken Tests to Perfect Architecture: The Great Cleanup of July 14"}],["$","meta","16",{"name":"twitter:description","content":"July 14"}],["$","link","17",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"32x33"}],["$","link","18",{"rel":"icon","href":"/favicon.ico","sizes":"32x32","type":"image/x-icon"}],["$","link","19",{"rel":"icon","href":"/pm-favicon-16.png","sizes":"16x16","type":"image/png"}],["$","link","20",{"rel":"icon","href":"/pm-favicon-32.png","sizes":"32x32","type":"image/png"}],["$","link","21",{"rel":"icon","href":"/pm-favicon-48.png","sizes":"48x48","type":"image/png"}],["$","link","22",{"rel":"apple-touch-icon","href":"/pm-favicon-180.png","sizes":"180x180","type":"image/png"}],["$","link","23",{"rel":"icon","href":"/pm-favicon-192.png","sizes":"192x192","type":"image/png"}],["$","$L1c","24",{}]],"error":null,"digest":"$undefined"}
18:"$13:metadata"
